#!/usr/bin/env ruby -W0

# "-W0" is against Fastimage's "warning: already initialized constant URI::DEFAULT_PARSER" on Ruby 2.0 and 2.1
#       that ruins binstub tests

Signal.trap :INT do
  abort "\n(interrupted by SIGINT)"
end



require "directlink"
DirectLink.silent = true

# TODO: use OptionParser
debug = json = nil
loop do
  case ARGV.first
  when "--debug"
    debug = ARGV.shift
    DirectLink.silent = false
  when "--json"
    json = ARGV.shift
  else
    break
  end
end
abort "usage: directlink [--debug] [--json] <link1> <link2> <link3> ..." if [nil, "-h", "--help"].include? ARGV.first

begin
  if json
    require "json"
    t = ARGV.map do |link|
      t = DirectLink link
      t.is_a?(Array) ? t.map(&:to_h) : t.to_h
    end
    puts JSON.pretty_generate t.size == 1 ? t.first : t
  else
    puts( ARGV.map do |link|
      t = DirectLink link
      (t.is_a?(Array) ? t : [t]).map{ |s| "#{s.url}\n#{s.type} #{s.width}x#{s.height}" }.join("\n")
    end.join "\n\n" )
  end
rescue FastImage::UnknownImageType,
       FastImage::ImageFetchFailure,
       DirectLink::ErrorMissingEnvVar,
       DirectLink::ErrorAssert,
       DirectLink::ErrorNotFound,
       DirectLink::ErrorBadLink => e
  puts e.backtrace if debug
  c = e.class.to_s
  abort c == e.to_s ? c : "#{c}: #{e}"
end
